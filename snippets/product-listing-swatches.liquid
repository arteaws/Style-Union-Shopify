<div class="product--grid__swatches">
  {% for option in product.options %}
    {%- liquid
      assign color_swatch_options = settings.swatch_option_names | replace: ' ,', ',' | replace: ', ', ',' | split: ',' | downcase
      assign size_swatch_options = "size, sizes, talle, dimensione, tamano, tamanho" | split: ", "
      assign option_handle = option | handle
      assign option_index = forloop.index0
      assign values = ''
      assign downcased_option = option | downcase
      assign max_visible_swatches = 5
      assign total_variants = 0
      assign visible_count = 0
    -%}

    {% liquid
      if color_swatch_options contains downcased_option and show_swatches
        assign swatch_type = 'color'
      elsif size_swatch_options contains downcased_option and show_sizes
        assign swatch_type = 'size'
      else
       continue
      endif
    -%}

    {% if swatch_type == 'color' or swatch_type == 'size' %}
      {% comment %} First count total available variants {% endcomment %}
      {% for variant in product.variants %}
        {% if variant.available %}
          {% assign value = variant.options[option_index] %}
          {% capture wrapped_value %},{{ value }},{% endcapture %}
          {% unless values contains wrapped_value %}
            {% assign total_variants = total_variants | plus: 1 %}
            {% capture values %}{{ values | append: wrapped_value }}{% endcapture %}
          {% endunless %}
        {% endif %}
      {% endfor %}
      
      {% assign values = '' %}
      <div class="prod-{{ swatch_type }}s">
        <div class="{{ swatch_type }}-swatch">
          <ul data-option-index="{{ option_index }}" class="{{ option_handle }} options">
            {% for variant in product.variants %}
              {% if variant.available %}
                {%- liquid
                  assign variant_image_url = blank
                  if variant.image
                    assign variant_image_url = variant.image | image_url: width: 100, height: 100, crop: 'center'
                  endif
                  assign value = variant.options[option_index]
                -%}
                
                {% capture wrapped_value %},{{ value }},{% endcapture %}
                {% unless values contains wrapped_value %}
                  {% assign visible_count = visible_count | plus: 1 %}
                  
                  {% if visible_count <= max_visible_swatches %}
                    <li data-option-title="{{ value | escape }}" class="{{ swatch_type }} {{ value | handle }}">
                      <a title="{{ value | escape }}" href="{{ variant.url | within: collection }}">
                        {% if swatch_type == 'color' %}
                          {% if variant_image_url %}
                            <span style="background-image: url({{ variant_image_url }}); background-size: cover;"></span>
                          {% else %}
                            {% liquid
                              assign css_color = value | split: ' ' | last | handle
                              if value.swatch.color and settings.color_swatch_style == 'swatch'
                                assign css_color = value.swatch.color
                              endif
                            %}
                            <span style="background-color: {{ css_color }}"></span>
                          {% endif %}
                        {% else %}
                          {{ value | escape }}
                        {% endif %}
                      </a>
                    </li>
                  {% endif %}
                  
                  {% capture values %}{{ values | append: wrapped_value }}{% endcapture %}
                {% endunless %}
              {% endif %}
            {% endfor %}
            
            {% if total_variants > max_visible_swatches %}
              {% assign remaining = total_variants | minus: max_visible_swatches %}
              <li class="more-variants">
                <a href="{{ product.url | within: collection }}" title="View all {{ total_variants }} options">
                  +{{ remaining }}
                </a>
              </li>
            {% endif %}
          </ul>
        </div><!-- .swatch -->
      </div>
    {% endif %}
  {% endfor %}
</div>

<style>
  .more-variants a {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background: #f5f5f5;
    color: #333;
    font-size: 12px;
    text-decoration: none;
  }
  
  .more-variants {
    width:20px;
    height: 20px;
    margin: 0 5px 5px 0;
  }
</style>